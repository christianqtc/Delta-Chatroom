
<!DOCTYPE html>
<html>
<head>
    <title>Delta Chatroom</title>
    <link rel="stylesheet" type="text/css" href="style.css"></link>
</head>
<body>
<p></p>
<h1>Delta Chatroom</h1>
<p></p>
<nav>
    <ul>

        <div class="dropdown">
  <button class="menubutton">Menu</button>
  <div class="dropdown-content">
    <a href="chatsite.html">Home</a>
    <a href="editprofile.html">Edit Profile</a>
    <a href="#">Contacts</a>
    <a href="#">Other</a>
  </div>
</div>

    <script>
    var ip = "%s"; // "134.154.62.221";

    var socket = new WebSocket( "ws://" + ip + ":8000/" );

    var usersArr = [""];

        // onopen is called when the WebSocket successfully establishes a connection with the server.
        socket.onopen = function( event ) {
            console.log( "Connection was opened!" );

            var reqmsgs =
            {
                type: "messagerequest"
            };
            // socket.send(JSON.stringify(reqmsgs));

            // Once the connection is opened, it is safe to send data to the server through the WebSocket.

            var testmsgs =
            {
              author: "username1",
              message: "testing the messages sent.",
              posted: "date",
              edited: "testing",
              type: "message"
            };

             // socket.send(JSON.stringify(testmsgs));
        };

        console.log( "Attempting to connect!" );





        // onmessage is called when the WebSocket receives data from the server.
         socket.onmessage = function(event) {
            handleMessage(event);
        };

        var datatest = {
          author: "CCAL22",
          message: "testing the data yo",
          posted: "Date.now().toString()",
          edited: "test",
          type: "message"
        };


        var datatest2 = {
          author: "MMURV15",
          message: "Doing some more testing k",
          posted: Date.now().toString(),
          edited: "test",
          type: "message"
        };



        var loginresulttest = {
            data : "{\"result\" :  true, \"type\" : \"loginresult\" }"
        };

        var usertest = {
            data : "{\"username\" : \"christianqtc\", \"password\" : \"******\"}"
        };

        var ul = "Users Online:" + "<br>";


        // handles the messages that are being sent from the server back to client
         function handleMessage( event ) {
            var chatz = document.getElementById("chatbox").contentDocument;
            var namez = document.getElementById("userlistbox").innerHTML;
            console.log("the received before parsed is :" + event.data);
            var received = JSON.parse(event.data);
            var username = received.author;
            var text = "";
            var msg = received.message;
            var time = received.posted;
            var timeStamp = Date.now();
            var d = Date(timeStamp);
            var dstring = d.toString();
            var dshort = dstring.substring(0,24);
            var jsontype = received.type;
            var result = received.result;

            console.log("jsontype is " + jsontype);

            // Displays the message only if json type received is a message.
            if (jsontype == "message")
            {
                console.log("this is a message!");

                text = "(" + dshort + ") <b>" + username + "</b>: " + msg + "<br>";




                if (text.length) {
                    chatz.write(text);
                    document.getElementById("chatbox").contentWindow;
                }
            }
            else
            {
                console.log("this is a login result!");

                if (result = true)
                {
                    createCookie(result);
                }

            }

            //console.log("USERNAME IS " + username);
            //console.log("IF STATEMENT " + usersArr.includes(username));

            if (usersArr.includes(username) == false)
            {
                usersArr.push(username);
                ul += username + "<br>";
                console.log("usersArr is " + usersArr);
            }
            document.getElementById("userlistbox").innerHTML = ul;

                //console.log("USERLIST IS " + ul);
            console.log( "Received a message: " + event.data );

        };


    function test()
    {
        //handleMessage(loginresulttest);
        //handleMessage(usertest);
        var msgjson = {
          author: "TEST USER 1",
          message: "TESTING DATA HERE ",
          posted: Date.now().toString(),
          edited: "test",
          type: "message"
        };
        //console.log("TEST 1"+datatest);
        console.log("THIS IS THE JSON" + msgjson);
        console.log("TEST 1" +JSON.stringify(msgjson));
        socket.send(JSON.stringify(msgjson));
        //handleMessage(JSON.stringify(datatest2));
        // verifyAllCookie();
    };


    var usertest = {
        data : "{\"username\" : \"christianqtc\", \"password\" : \"******\"}"
    };

    var name = verifyCookie(name);
    console.log(verifyCookie(name));



    function sendmessage()
    {
        var textMessage = document.getElementById("msgBox").value;
        var datetext = Date.now().toString().substring(0,15);
        console.log("THE DATE IS " + datetext);
        var msgjson = {
          author: verifyCookie("username"),
          message: textMessage,
          posted: datetext,
          edited: "",
          type: "message"
        };

        document.getElementById("msgBox")
        .addEventListener("keyup", function(event) {
        event.preventDefault();
        if (event.keyCode === 13) {
           console.log("ENTER BUTTON PUSHED");
            document.getElementById("msgBox").click();
            sendmessage();
        }
    });

        socket.send(JSON.stringify(msgjson));

    };


    function displaymessage()
    {
        sendmessage()
    }


    function createCookie(username)
    {
        var d = new Date();
        d.setTime(d.getTime() + (24 * 60 * 60 * 1000));
        document.cookie = "username=CCAL22; path=/";
        document.cookie = "password=pass123; path=/";
        document.cookie = "loginresult=true; path=/";
        alert("Cookies test... set to name= " + username);
        console.log("cookies created..");
    }

    function verifyCookie(name)
    {
        var name = name + "=";
        var seperate = document.cookie.split(';');
        for(var i=0;i < seperate.length;i++) {
          var cook = seperate[i];
          while (cook.charAt(0)==' ')
              cook = cook.substring(1,cook.length);
          if (cook.indexOf(name) == 0)
              return cook.substring(name.length,cook.length);
        }
        return null;
    }

    function verifyAllCookie()
    {
      verifyCookie("username");
      verifyCookie("password");
      verifyCookie("loginresult");
    }

    function deleteCookie()
    {
        document.cookie = "username=; expires=Thu, 22 Feb 1990 12:00:00 UTC; path=/";
        document.cookie = "password=; expires=Thu, 22 Feb 1990 12:00:00 UTC; path=/";
        document.cookie = "loginresult=; expires=Thu, 22 Feb 1990 12:00:00 UTC; path=/";
        console.log("COOKIES DELETED");
    }

    </script>

    <button type="button" onclick="connect()" style="display: none">Connect!</button>

    <button type="button" onclick="test()" style="display: none">Testing!</button>

<br>
<br>


  <table border="0" width="100%">

  <tr height="100%">

  <td width="120px" align="top" border="1" height="100%" style="">

  <div id="userlistbox" class"bordered" style="border: 3px solid lightgreen; width:115%; height:100%; border-radius: 8px;"></div>

  </td>
  <td>
  <iframe width="100%" height="400px" id="chatbox"></iframe>
  <tr>
  <td>&nbsp;</td>
  <td>

<br>
<br>


<input id="msgBox" type="text" name="text" rows="4" cols="50" size="75" maxlength="256" placeholder="Chat with us!" autocomplete="off">
  <input type="button" id="send" name="send" value="Send" onclick="sendmessage()"></p></td>







    <a href="editprofile.html" id="logoutbutton" onclick="deleteCookie()"style="float: right; color: white; font-weight: bold;">Logout</a>
    </ul>
</nav>

<br>


<style>
table {
    border-collapse: collapse;
    border: 1px solid orange;
    background: #fff;
    padding: 25px;
    margin: 40px;
}
th, td
{
    text-align: left;
    padding: 8px;
}

tr:nth-child(even)
{
background-color: #f2f2f2;
}
</style>

<!--
<table id="userlist" width="190" height="600">
<tbody>
<tr>
<td style="width: 180px;">
    <p>Users List</p>
</td>
</tr>
<tr>
<td style="width: 180px;">
    <div id"userlistbox2">
    <p>Christian <img src="https://www.wpclipart.com/blanks/shapes/color_labels/circle/color_label_circle_green.png" width="10%" height="10%" align="right">
            </div>
    </p>
    </div>
</td>
</tr>
<tr>
<td style="width: 180px;">
    <p>Neil<img src="https://www.wpclipart.com/blanks/shapes/color_labels/circle/color_label_circle_green.png" width="10%" height="10%" align="right"></p>
    </td>
</tr>
<tr>
<td style="width: 180px;">
    <p>Other Usernames... <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/07/Button_Icon_Red.svg/2000px-Button_Icon_Red.svg.png" width="10%" height="10%" align="right"></p>
    </td>
</tr>
<tr>
<td style="width: 180px;"></td>
</tr>
<tr>
<td style="width: 180px;"></td>
</tr>
<tr>
<td style="width: 180px;"></td>
</tr>
<tr>
<td style="width: 180px;"></td>
</tr>
<tr>
<td style="width: 180px;"></td>
</tr>
<tr>
<td style="width: 180px;"></td>
</tr>
</tbody>
</table>

<div class="chattext">
            <textarea></textarea>
            <button>Send</button>
        </div>

      -->
</body>
</html>
